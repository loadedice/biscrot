#!/usr/bin/env node

/* todo
 * allow of arguements to modify scrot and img.bi's settings (don't open in browser, copy to clipboard and some more)
 * have a log file so you can see all that you've uploaded, log delete links too.
 */
var exec = require('child_process').exec;
var fs = require('fs');

var imgbi = require('imgbi');
var argv = require('yargs')
    .usage("Quickly upload your scrots to img.bi\nUsage: $0")
    .argv;
/* The args so far are:
 * --ar, to print the autoremove link
 * -d, to delete the file after uploading it.
 * -o to open in browser afterward
 *  I need to make use of yargs so it prints helpful stuff
 */
var options = {};
options.expire = '1'; //Most screenshot stuff I send I don't need longer than 1 day, so 1 day will be default.
options.url = 'https://img.bi';

exec("scrot -se 'echo -n $f'",function(error, stdout){
    if (error !== null){
        console.log('ERROR: '+error);
        process.exit(1);
    }
    else{
        options.file = stdout;

        imgbi.upload(options, function(err, result) {
            if (err) {
                new Error(err); // if there any error during the upload
                // I should make it retry 3 times before giving up. Which might require me to make this another function.
                process.exit(1);
            }
            else {
                console.log("View link: "+result.viewlink); // link to view image
                console.log("Remove link: "+result.rmlink); // filename + link to remove image
                if(argv.o){
                    exec("xdg-open "+result.viewlink);
                }
                if(argv.ar){
                    console.log("Auto rm link: "+result.autormlink); // link to autoremove image after first view
                }
                if(argv.d){
                    fs.unlinkSync(options.file);
                }
                //console.log(options.file, result.rmlink); // filename + link to remove image
            }
        });
    }
})
